name: Test Ubuntu LTS Versions

on:
  schedule:
    # Weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  
  workflow_dispatch:
    inputs:
      ubuntu_version:
        description: 'Ubuntu version to test (22.04, 24.04, 26.04)'
        required: false
        default: 'all'
      test_pre_release:
        description: 'Test pre-release/daily builds'
        required: false
        type: boolean
        default: false
      lokole_version:
        description: 'Lokole version to test (leave empty for latest PyPI)'
        required: false
      iiab_branch:
        description: 'IIAB branch to test (default: master)'
        required: false
        default: 'master'

jobs:
  test-version:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - ubuntu_version: "22.04"
            python_expected: "3.10"
            use_daily: false
          - ubuntu_version: "24.04"
            python_expected: "3.12"
            use_daily: false
          - ubuntu_version: "26.04"
            python_expected: "3.13"
            use_daily: true
            # Note: Will auto-upgrade to 3.14 when available
    
    steps:
      - name: Checkout test repository
        uses: actions/checkout@v4
      
      - name: Set up Multipass
        run: |
          sudo snap install multipass
          multipass version
      
      - name: Make scripts executable
        run: |
          chmod +x scripts/scenarios/*.sh
          chmod +x scripts/vm/multipass/*.sh
          chmod +x scripts/verify/*.sh
      
      - name: Run fresh installation test
        id: test
        run: |
          ARGS="--ubuntu-version ${{ matrix.ubuntu_version }}"
          
          if [ "${{ matrix.use_daily }}" = "true" ]; then
            ARGS="$ARGS --use-daily"
          fi
          
          if [ "${{ inputs.lokole_version }}" != "" ]; then
            ARGS="$ARGS --lokole-version ${{ inputs.lokole_version }}"
          fi
          
          if [ "${{ inputs.iiab_branch }}" != "" ]; then
            ARGS="$ARGS --iiab-branch ${{ inputs.iiab_branch }}"
          fi
          
          ./scripts/scenarios/fresh-install.sh $ARGS
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-${{ matrix.ubuntu_version }}-python-${{ matrix.python_expected }}-results
          path: |
            *.txt
            *.json
            *.md
            *.log
      
      - name: Create issue on failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let body = '## ðŸ”´ Ubuntu ${{ matrix.ubuntu_version }} Integration Test Failed\n\n';
            body += '**Expected Python:** ${{ matrix.python_expected }}\n';
            body += '**Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n';
            
            // Try to read JSON report first (new format)
            const jsonFiles = fs.readdirSync('.').filter(f => f.includes('verification') && f.endsWith('.json'));
            if (jsonFiles.length > 0) {
              const jsonContent = JSON.parse(fs.readFileSync(jsonFiles[0], 'utf8'));
              body += `### System Info\n`;
              body += `- **OS:** Ubuntu ${jsonContent.system.os_version} (${jsonContent.system.os_codename})\n`;
              body += `- **Python:** ${jsonContent.system.python_version}\n`;
              body += `- **Summary:** ${jsonContent.summary}\n\n`;
              body += `### Check Results\n`;
              body += `- âœ… Passed: ${jsonContent.checks.passed}/${jsonContent.checks.total}\n`;
              body += `- âŒ Failed: ${jsonContent.checks.failed}/${jsonContent.checks.total}\n`;
              body += `- âš ï¸ Warnings: ${jsonContent.checks.warnings}/${jsonContent.checks.total}\n\n`;
            }
            
            // Include markdown comment if available
            const mdFiles = fs.readdirSync('.').filter(f => f.includes('pr-comment') && f.endsWith('.md'));
            if (mdFiles.length > 0) {
              const mdContent = fs.readFileSync(mdFiles[0], 'utf8');
              body += mdContent;
            } else {
              // Fallback to text report
              const reportFiles = fs.readdirSync('.').filter(f => f.endsWith('.txt'));
              if (reportFiles.length > 0) {
                const content = fs.readFileSync(reportFiles[0], 'utf8');
                body += '### Test Output\n```\n' + content.slice(0, 5000) + '\n```';
              }
            }
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Integration test failure: Ubuntu ${{ matrix.ubuntu_version }} (Python ${{ matrix.python_expected }})`,
              body: body,
              labels: ['bug', 'automated-test-failure', 'ubuntu-${{ matrix.ubuntu_version }}']
            });
