name: Test Ubuntu LTS Versions

on:
  schedule:
    # Weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  
  workflow_dispatch:
    inputs:
      ubuntu_version:
        description: 'Ubuntu version to test (22.04, 24.04, 26.04)'
        required: false
        default: 'all'
      test_pre_release:
        description: 'Test pre-release/daily builds'
        required: false
        type: boolean
        default: false
      lokole_version:
        description: 'Lokole version to test (leave empty for latest PyPI)'
        required: false
      iiab_branch:
        description: 'IIAB branch to test (default: master)'
        required: false
        default: 'master'

jobs:
  detect-ubuntu-versions:
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.detect.outputs.versions }}
    
    steps:
      - name: Detect available Ubuntu LTS versions
        id: detect
        run: |
          # Query Ubuntu releases
          VERSIONS='["22.04", "24.04"]'
          
          # Check if 26.04 daily is available (pre-release)
          if multipass find | grep -q "26.04"; then
            VERSIONS='["22.04", "24.04", "26.04"]'
          fi
          
          echo "versions=$VERSIONS" >> $GITHUB_OUTPUT
  
  test-version:
    needs: detect-ubuntu-versions
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ubuntu_version: ${{ fromJson(needs.detect-ubuntu-versions.outputs.versions) }}
    
    steps:
      - name: Checkout test repository
        uses: actions/checkout@v4
      
      - name: Set up Multipass
        run: |
          sudo snap install multipass
          multipass version
      
      - name: Make scripts executable
        run: |
          chmod +x scripts/scenarios/*.sh
          chmod +x scripts/vm/multipass/*.sh
          chmod +x scripts/verify/*.sh
      
      - name: Run fresh installation test
        id: test
        run: |
          ARGS="--ubuntu-version ${{ matrix.ubuntu_version }}"
          
          if [ "${{ inputs.lokole_version }}" != "" ]; then
            ARGS="$ARGS --lokole-version ${{ inputs.lokole_version }}"
          fi
          
          if [ "${{ inputs.iiab_branch }}" != "" ]; then
            ARGS="$ARGS --iiab-branch ${{ inputs.iiab_branch }}"
          fi
          
          ./scripts/scenarios/fresh-install.sh $ARGS
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-${{ matrix.ubuntu_version }}-results
          path: |
            *.txt
            *.log
      
      - name: Create issue on failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let body = '## ðŸ”´ Ubuntu ${{ matrix.ubuntu_version }} Integration Test Failed\n\n';
            body += '**Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n';
            
            const reportFiles = fs.readdirSync('.').filter(f => f.endsWith('.txt'));
            if (reportFiles.length > 0) {
              const content = fs.readFileSync(reportFiles[0], 'utf8');
              body += '### Test Output\n```\n' + content.slice(0, 5000) + '\n```';
            }
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Integration test failure: Ubuntu ${{ matrix.ubuntu_version }}`,
              body: body,
              labels: ['bug', 'automated-test-failure']
            });
