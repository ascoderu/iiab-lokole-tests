name: Test on PR Label

on:
  repository_dispatch:
    types:
      - test-integration-lokole
      - test-integration-iiab

jobs:
  test-pr:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - ubuntu_version: "22.04"
            python_expected: "3.10"
          - ubuntu_version: "24.04"
            python_expected: "3.12"
          - ubuntu_version: "26.04"
            python_expected: "3.13"
            use_daily: true
    
    steps:
      - name: Checkout test repository
        uses: actions/checkout@v4
      
      - name: Extract PR details
        id: pr_details
        run: |
          echo "pr_number=${{ github.event.client_payload.pr_number }}" >> $GITHUB_OUTPUT
          echo "pr_ref=${{ github.event.client_payload.ref }}" >> $GITHUB_OUTPUT
          echo "pr_sha=${{ github.event.client_payload.sha }}" >> $GITHUB_OUTPUT
          echo "pr_repo=${{ github.event.client_payload.repo }}" >> $GITHUB_OUTPUT
      
      - name: Set up Multipass
        run: |
          sudo snap install multipass
          multipass version
      
      - name: Make scripts executable
        run: |
          chmod +x scripts/scenarios/*.sh
          chmod +x scripts/vm/multipass/*.sh
          chmod +x scripts/verify/*.sh
      
      - name: Run PR test scenario
        id: test
        run: |
          ARGS="--pr-repo ${{ steps.pr_details.outputs.pr_repo }}"
          ARGS="$ARGS --pr-ref ${{ steps.pr_details.outputs.pr_ref }}"
          ARGS="$ARGS --pr-sha ${{ steps.pr_details.outputs.pr_sha }}"
          ARGS="$ARGS --pr-number ${{ steps.pr_details.outputs.pr_number }}"
          ARGS="$ARGS --ubuntu-version ${{ matrix.ubuntu_version }}"
          
          if [ "${{ matrix.use_daily }}" = "true" ]; then
            ARGS="$ARGS --use-daily"
          fi
          
          ./scripts/scenarios/test-pr-branch.sh $ARGS
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-${{ steps.pr_details.outputs.pr_number }}-ubuntu-${{ matrix.ubuntu_version }}-results
          path: |
            *.txt
            *.json
            *.md
            *.log
      
      - name: Post results as comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.INTEGRATION_TEST_PAT }}
          script: |
            const fs = require('fs');
            const payload = context.payload.client_payload;
            const [owner, repo] = payload.repo.split('/');
            
            // Read markdown comment
            const mdFiles = fs.readdirSync('.').filter(f => f.includes('pr-comment') && f.endsWith('.md'));
            let reportContent = '';
            
            if (mdFiles.length > 0) {
              reportContent = fs.readFileSync(mdFiles[0], 'utf8');
              // Add matrix info header
              reportContent = `## Test Result for Ubuntu ${{ matrix.ubuntu_version }} (Python ${{ matrix.python_expected }})\n\n` + reportContent;
            } else {
              // Fallback to basic report
              reportContent = '## Integration Test Results\n\n';
              reportContent += '**Ubuntu:** ${{ matrix.ubuntu_version }}\n';
              reportContent += '**Expected Python:** ${{ matrix.python_expected }}\n\n';
              
              const reportFiles = fs.readdirSync('.').filter(f => f.endsWith('.txt'));
              if (reportFiles.length > 0) {
                const content = fs.readFileSync(reportFiles[0], 'utf8');
                reportContent += '```\n' + content + '\n```';
              } else {
                reportContent += '⚠️ No test report generated';
              }
            }
            
            await github.rest.issues.createComment({
              owner: owner,
              repo: repo,
              issue_number: payload.pr_number,
              body: reportContent
            });
