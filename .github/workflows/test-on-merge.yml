name: Test on Merge

on:
  repository_dispatch:
    types:
      - lokole-merged
      - iiab-merged

jobs:
  test-merged-version:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout test repository
        uses: actions/checkout@v4
      
      - name: Extract merge details
        id: merge_details
        run: |
          echo "branch=${{ github.event.client_payload.branch }}" >> $GITHUB_OUTPUT
          echo "sha=${{ github.event.client_payload.sha }}" >> $GITHUB_OUTPUT
          echo "repo=${{ github.event.client_payload.repo }}" >> $GITHUB_OUTPUT
      
      - name: Set up Multipass
        run: |
          sudo snap install multipass
          multipass version
      
      - name: Make scripts executable
        run: |
          chmod +x scripts/scenarios/*.sh
          chmod +x scripts/vm/multipass/*.sh
          chmod +x scripts/verify/*.sh
      
      - name: Run fresh install with merged version
        id: test
        run: |
          REPO="${{ steps.merge_details.outputs.repo }}"
          
          if [[ "$REPO" == *"lokole"* ]]; then
            # Test merged Lokole commit
            ./scripts/scenarios/fresh-install.sh \
              --ubuntu-version 24.04 \
              --lokole-commit ${{ steps.merge_details.outputs.sha }}
          elif [[ "$REPO" == *"iiab"* ]]; then
            # Test merged IIAB branch
            ./scripts/scenarios/fresh-install.sh \
              --ubuntu-version 24.04 \
              --iiab-branch ${{ steps.merge_details.outputs.branch }}
          fi
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: post-merge-results
          path: |
            *.txt
            *.log
      
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const payload = context.payload.client_payload;
            
            let body = '## ðŸ”´ Post-Merge Integration Test Failed\n\n';
            body += `**Repository:** ${payload.repo}\n`;
            body += `**Branch:** ${payload.branch}\n`;
            body += `**Commit:** ${payload.sha}\n`;
            body += `**Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n`;
            
            const reportFiles = fs.readdirSync('.').filter(f => f.endsWith('.txt'));
            if (reportFiles.length > 0) {
              const content = fs.readFileSync(reportFiles[0], 'utf8');
              body += '### Test Output\n```\n' + content.slice(0, 5000) + '\n```';
            }
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Post-merge test failure: ${payload.repo}@${payload.sha.slice(0, 7)}`,
              body: body,
              labels: ['bug', 'automated-test-failure', 'post-merge']
            });
